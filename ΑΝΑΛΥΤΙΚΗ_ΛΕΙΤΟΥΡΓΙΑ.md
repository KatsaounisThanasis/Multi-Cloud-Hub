# ðŸ—ï¸ Multi-Cloud Infrastructure Management API - Î Î»Î®ÏÎ·Ï‚ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚

## ðŸ“‹ Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î±
1. [Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î‘ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ®Ï‚](#architecture)
2. [Î¡Î¿Î® Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚ (Î‘Ï€ÏŒ Ï„Î·Î½ Î‘ÏÏ‡Î® Î¼Î­Ï‡ÏÎ¹ Ï„Î¿ Î¤Î­Î»Î¿Ï‚)](#request-flow)
3. [Î’Î±ÏƒÎ¹ÎºÎ¬ ÎšÎ¿Î¼Î¼Î¬Ï„Î¹Î± ÏƒÎµ Î’Î¬Î¸Î¿Ï‚](#components)
4. [Î£Ï‡Î®Î¼Î± Î’Î¬ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½](#database)
5. [Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Deployment Î’Î®Î¼Î±-Î’Î®Î¼Î±](#deployment)
6. [Docker & Î¥Ï€Î¿Î´Î¿Î¼Î®](#docker)
7. [Î”Î¿Î¼Î® Î‘ÏÏ‡ÎµÎ¯Ï‰Î½](#structure)

---

## ðŸŽ¯ Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î‘ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ®Ï‚ {#architecture}

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Î ÎµÎ»Î¬Ï„Î·Ï‚   â”‚ (cURL, Postman, Frontend)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP Î‘Î¯Ï„Î·Î¼Î±
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI (api_rest.py)        â”‚
â”‚  - Endpoints (/deploy, /templates)   â”‚
â”‚  - ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚ (Pydantic)      â”‚
â”‚  - Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â†’ PostgreSQL (Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· deployments)
       â”‚
       â”œâ”€â”€â”€â”€â”€â†’ Celery (ÎŸÏ…ÏÎ¬ Î³Î¹Î± async tasks)
       â”‚
       â””â”€â”€â”€â”€â”€â†’ Template Manager (Î•ÏÏÎµÏƒÎ· templates)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Redis Message Broker         â”‚
â”‚    (ÎŸÏ…ÏÎ¬ Î³Î¹Î± Celery tasks)           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Celery Worker Process         â”‚
â”‚  - Î Î±Î¯ÏÎ½ÎµÎ¹ deployment tasks          â”‚
â”‚  - Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ provider instance      â”‚
â”‚  - Î•ÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¿ deployment             â”‚
â”‚  - Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î· Î²Î¬ÏƒÎ· Î¼Îµ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â†’ Azure (Bicep deployment)
       â”œâ”€â”€â”€â”€â”€â†’ AWS (Terraform)
       â””â”€â”€â”€â”€â”€â†’ GCP (Terraform)
```

---

## ðŸ”„ Î¡Î¿Î® Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚ (Î‘Ï€ÏŒ Ï„Î·Î½ Î‘ÏÏ‡Î® Î¼Î­Ï‡ÏÎ¹ Ï„Î¿ Î¤Î­Î»Î¿Ï‚) {#request-flow}

### **Î£ÎµÎ½Î¬ÏÎ¹Î¿: ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎºÎ¬Î½ÎµÎ¹ deploy Î­Î½Î± S3 bucket ÏƒÏ„Î¿ AWS**

#### **Î’Î®Î¼Î± 1: ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ ÏƒÏ„Î­Î»Î½ÎµÎ¹ Î±Î¯Ï„Î·Î¼Î± deployment**
```bash
POST http://localhost:8000/deploy
{
  "template_name": "storage-bucket",
  "provider_type": "terraform-aws",
  "subscription_id": "123456789012",
  "resource_group": "my-resources",
  "location": "us-east-1",
  "parameters": {
    "bucket_name": "my-awesome-bucket"
  }
}
```

#### **Î’Î®Î¼Î± 2: Î¤Î¿ FastAPI Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î¿ Î±Î¯Ï„Î·Î¼Î±** (`api_rest.py:297`)
```python
async def deploy_infrastructure(request: DeploymentRequest, db: Session = Depends(get_db)):
```

**Î¤Î¹ Î³Î¯Î½ÎµÏ„Î±Î¹:**
1. **Î•Î»Î­Î³Ï‡ÎµÎ¹ Ï„Î¿ Î±Î¯Ï„Î·Î¼Î±** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏŽÎ½Ï„Î±Ï‚ Pydantic model
2. **Î•Î»Î­Î³Ï‡ÎµÎ¹ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿ template** Î¼Î­ÏƒÏ‰ `template_manager.get_template_path()`
3. **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ deployment ID**: `deploy-a1b2c3d4e5f6`
4. **Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ ÎµÎ³Î³ÏÎ±Ï†Î® ÏƒÏ„Î· Î²Î¬ÏƒÎ·**:
   ```python
   deployment = Deployment(
       deployment_id="deploy-a1b2c3d4e5f6",
       provider_type="terraform-aws",
       cloud_provider="aws",
       template_name="storage-bucket",
       resource_group="my-resources",
       status=PENDING,  # Î£Îµ Î±Î½Î±Î¼Î¿Î½Î®
       parameters={"bucket_name": "my-awesome-bucket"}
   )
   db.add(deployment)
   db.commit()
   ```

#### **Î’Î®Î¼Î± 3: Î’Î¬Î¶ÎµÎ¹ Ï„Î¿ task ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬ Celery** (`api_rest.py:346`)
```python
task = deploy_task.delay(
    deployment_id="deploy-a1b2c3d4e5f6",
    provider_type="terraform-aws",
    template_path="/app/templates/terraform/aws/storage-bucket.tf",
    parameters={"bucket_name": "my-awesome-bucket"},
    resource_group="my-resources",
    provider_config={
        "subscription_id": "123456789012",
        "region": "us-east-1"
    }
)
```

**Î¤Î¹ Î³Î¯Î½ÎµÏ„Î±Î¹:**
- Î¤Î¿ Celery ÎºÎ¬Î½ÎµÎ¹ serialize Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… task ÏƒÎµ JSON
- Î¤Î± ÏƒÏ„Î­Î»Î½ÎµÎ¹ ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬ Ï„Î¿Ï… Redis
- Î¤Î¿ Redis Ï„Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ ÏƒÎµ Î»Î¯ÏƒÏ„Î±: `celery:tasks`
- Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Î±Î¼Î­ÏƒÏ‰Ï‚ ÏƒÏ„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î·

#### **Î’Î®Î¼Î± 4: Î¤Î¿ FastAPI ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·** (202 Accepted)
```json
{
  "success": true,
  "message": "Deployment queued successfully",
  "data": {
    "deployment_id": "deploy-a1b2c3d4e5f6",
    "status": "pending",
    "task_id": "celery-task-uuid-here",
    "template": "storage-bucket"
  }
}
```

**â±ï¸ Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Ï‡ÏÏŒÎ½Î¿Ï‚: ~100-200ms** (Î¼Î·-blocking!)

---

#### **Î’Î®Î¼Î± 5: ÎŸ Celery Worker Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿ task** (`tasks.py:37`)

**ÎŸ Celery worker Ï„ÏÎ­Ï‡ÎµÎ¹ ÏƒÏ„Î¿ background:**
```bash
celery -A backend.celery_app worker --loglevel=info
```

**ÎŸ Worker Î²Î»Î­Ï€ÎµÎ¹ Ï„Î¿ Î½Î­Î¿ task ÏƒÏ„Î¿ Redis ÎºÎ±Î¹ Ï„Î¿ ÎµÎºÏ„ÎµÎ»ÎµÎ¯:**
```python
@celery_app.task(bind=True, base=DatabaseTask)
def deploy_infrastructure(self, deployment_id, provider_type, ...):
```

**Î¤Î¹ Î³Î¯Î½ÎµÏ„Î±Î¹:**
1. **Î Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿ deployment Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ·**:
   ```python
   deployment = db.query(Deployment).filter_by(deployment_id=deployment_id).first()
   ```

2. **Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î¿ status ÏƒÎµ RUNNING** (Î•ÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹):
   ```python
   deployment.status = DeploymentStatus.RUNNING
   deployment.started_at = datetime.utcnow()
   db.commit()
   ```

3. **Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î¿ Celery task state** (Î³Î¹Î± real-time monitoring):
   ```python
   self.update_state(
       state="RUNNING",
       meta={"status": "initializing", "progress": 10}
   )
   ```

#### **Î’Î®Î¼Î± 6: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Provider Instance** (`tasks.py:62`)
```python
provider = ProviderFactory.create_provider(
    "terraform-aws",
    subscription_id="123456789012",
    region="us-east-1"
)
```

**Î›Î¿Î³Î¹ÎºÎ® Ï„Î¿Ï… Provider Factory** (`providers/factory.py:54`):
```python
def create_provider(provider_type: str, **kwargs):
    if provider_type == "terraform-aws":
        return TerraformProvider(
            cloud_platform="aws",
            region=kwargs.get("region"),
            subscription_id=kwargs.get("subscription_id")
        )
```

**Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· TerraformProvider** (`providers/terraform_provider.py:39`):
```python
def __init__(self, subscription_id, region, cloud_platform="aws"):
    super().__init__(subscription_id, region)
    self.cloud_platform = "aws"
    self.working_dir = tempfile.mkdtemp(prefix="terraform_")  # /tmp/terraform_xyz/

    # Î•Î»Î­Î³Ï‡ÎµÎ¹ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎµÎ³ÎºÎ±Ï„ÎµÏƒÏ„Î·Î¼Î­Î½Î¿ Ï„Î¿ Terraform
    if not self._check_terraform_installed():
        raise ProviderConfigurationError("Terraform not installed")
```

#### **Î’Î®Î¼Î± 7: Î•ÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¿ Deployment** (`tasks.py:73`)
```python
result = provider.deploy(
    template_path="/app/templates/terraform/aws/storage-bucket.tf",
    resource_group_name="my-resources",
    parameters={"bucket_name": "my-awesome-bucket"}
)
```

**ÎœÎ­ÏƒÎ± ÏƒÏ„Î¿ TerraformProvider.deploy()** (`providers/terraform_provider.py:320`):

**7a. Î•Ï„Î¿Î¹Î¼Î¬Î¶ÎµÎ¹ Ï„Î¿ Terraform workspace**
```python
# Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†ÎµÎ¹ Ï„Î¿ template ÏƒÏ„Î¿Î½ working directory
shutil.copy(template_path, f"{self.working_dir}/main.tf")

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ terraform.tfvars Î¼Îµ Ï„Î¹Ï‚ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï…Ï‚
with open(f"{self.working_dir}/terraform.tfvars", "w") as f:
    f.write('bucket_name = "my-awesome-bucket"\n')
```

**7b. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ provider configuration**
```python
# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ providers.tf
provider_config = {
    "provider": {
        "aws": {
            "region": "us-east-1"
        }
    }
}
with open(f"{self.working_dir}/providers.tf", "w") as f:
    json.dump(provider_config, f)
```

**7c. Î¤ÏÎ­Ï‡ÎµÎ¹ Terraform init**
```python
subprocess.run(
    ["terraform", "init"],
    cwd=self.working_dir,
    check=True,
    capture_output=True
)
```
ÎˆÎ¾Î¿Î´Î¿Ï‚:
```
Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Installing hashicorp/aws v5.31.0...
Terraform has been successfully initialized!
```

**7d. Î¤ÏÎ­Ï‡ÎµÎ¹ Terraform plan**
```python
subprocess.run(
    ["terraform", "plan", "-out=tfplan"],
    cwd=self.working_dir,
    check=True
)
```

**7e. Î¤ÏÎ­Ï‡ÎµÎ¹ Terraform apply**
```python
subprocess.run(
    ["terraform", "apply", "-auto-approve", "tfplan"],
    cwd=self.working_dir,
    check=True
)
```
ÎˆÎ¾Î¿Î´Î¿Ï‚:
```
aws_s3_bucket.main: Creating...
aws_s3_bucket.main: Creation complete after 2s [id=my-awesome-bucket]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

**7f. Î Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î± outputs**
```python
result = subprocess.run(
    ["terraform", "output", "-json"],
    cwd=self.working_dir,
    capture_output=True,
    text=True
)
outputs = json.loads(result.stdout)
```

**â±ï¸ Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Ï‡ÏÏŒÎ½Î¿Ï‚ deployment: 2-10 Î»ÎµÏ€Ï„Î¬**

---

#### **Î’Î®Î¼Î± 8: Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î· Î’Î¬ÏƒÎ· Î¼Îµ Ï„Î± Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±** (`tasks.py:87`)

**Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚:**
```python
deployment.status = DeploymentStatus.COMPLETED  # ÎŸÎ»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ
deployment.completed_at = datetime.utcnow()
deployment.outputs = {
    "bucket_name": "my-awesome-bucket",
    "bucket_arn": "arn:aws:s3:::my-awesome-bucket",
    "bucket_region": "us-east-1"
}
db.commit()
```

**Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Î±Ï€Î¿Ï„Ï…Ï‡Î¯Î±Ï‚:**
```python
except DeploymentError as e:
    deployment.status = DeploymentStatus.FAILED  # Î‘Ï€Î­Ï„Ï…Ï‡Îµ
    deployment.error_message = str(e)
    deployment.logs = traceback.format_exc()
    db.commit()
```

---

#### **Î’Î®Î¼Î± 9: ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Ï„Î¿ status**

**Î•Î½ÏŽ Ï„Î¿ deployment Ï„ÏÎ­Ï‡ÎµÎ¹:**
```bash
GET http://localhost:8000/deployments/deploy-a1b2c3d4e5f6/status
```

Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·:
```json
{
  "deployment_id": "deploy-a1b2c3d4e5f6",
  "status": "running",
  "started_at": "2025-11-09T12:00:00",
  "duration_seconds": 45.2,
  "provider_type": "terraform-aws",
  "template_name": "storage-bucket"
}
```

**ÎœÎµÏ„Î¬ Ï„Î·Î½ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·:**
```json
{
  "deployment_id": "deploy-a1b2c3d4e5f6",
  "status": "completed",
  "started_at": "2025-11-09T12:00:00",
  "completed_at": "2025-11-09T12:02:30",
  "duration_seconds": 150.0,
  "outputs": {
    "bucket_name": "my-awesome-bucket",
    "bucket_arn": "arn:aws:s3:::my-awesome-bucket"
  }
}
```

---

## ðŸ§© Î’Î±ÏƒÎ¹ÎºÎ¬ ÎšÎ¿Î¼Î¼Î¬Ï„Î¹Î± ÏƒÎµ Î’Î¬Î¸Î¿Ï‚ {#components}

### **1. Î•Ï†Î±ÏÎ¼Î¿Î³Î® FastAPI** (`backend/api_rest.py`)

**Î£ÎºÎ¿Ï€ÏŒÏ‚:** HTTP API layer

**Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ ÎµÏ…Î¸ÏÎ½ÎµÏ‚:**
- Î›Î±Î¼Î²Î¬Î½ÎµÎ¹ HTTP Î±Î¹Ï„Î®Î¼Î±Ï„Î±
- Î•Î»Î­Î³Ï‡ÎµÎ¹ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… (Pydantic models)
- Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ database sessions
- Î’Î¬Î¶ÎµÎ¹ tasks ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬ Ï„Î¿Ï… Celery
- Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚

**Î’Î±ÏƒÎ¹ÎºÎ¬ endpoints:**

| Endpoint | ÎœÎ­Î¸Î¿Î´Î¿Ï‚ | Î£ÎºÎ¿Ï€ÏŒÏ‚ |
|----------|---------|---------|
| `/health` | GET | ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï…Î³ÎµÎ¯Î±Ï‚ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ |
| `/providers` | GET | Î›Î¯ÏƒÏ„Î± cloud providers |
| `/templates` | GET | Î›Î¯ÏƒÏ„Î± templates |
| `/templates/{provider}/{name}` | GET | Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ template |
| `/deploy` | POST | Î’Î¬Î¶ÎµÎ¹ deployment ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬ |
| `/deployments` | GET | Î›Î¯ÏƒÏ„Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ deployments |
| `/deployments/{id}/status` | GET | Status ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… deployment |

**Î•Î½ÏƒÏ‰Î¼Î¬Ï„Ï‰ÏƒÎ· Î¼Îµ Ï„Î· Î²Î¬ÏƒÎ·:**
```python
@app.on_event("startup")
async def startup_event():
    init_db()  # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î¿Ï…Ï‚ Ï€Î¯Î½Î±ÎºÎµÏ‚ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½
```

---

### **2. Î•Ï†Î±ÏÎ¼Î¿Î³Î® Celery** (`backend/celery_app.py`)

**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î”Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Î¿Ï…ÏÎ¬Ï‚ ÎµÏÎ³Î±ÏƒÎ¹ÏŽÎ½

**Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚:**
```python
celery_app = Celery(
    "cloud_manager",
    broker="redis://localhost:6379/0",  # Î Î¿Ï… Î¼Ï€Î±Î¯Î½Î¿Ï…Î½ Ï„Î± tasks
    backend="redis://localhost:6379/0",  # Î Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±
)

# Î”ÏÎ¿Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· tasks (Ï€Î¿Î¹Î¿ task ÏƒÎµ Ï€Î¿Î¹Î± Î¿Ï…ÏÎ¬)
task_routes = {
    "backend.tasks.deploy_infrastructure": {"queue": "deployments"},
    "backend.tasks.cleanup_deployment": {"queue": "maintenance"},
}
```

**Î“Î¹Î±Ï„Î¯ Redis;**
- Î¤Î±Ï‡ÏÏ„Î±Ï„Î· in-memory Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
- Messaging Pub/Sub
- Atomic operations (Î±Ï„Î¿Î¼Î¹ÎºÎ­Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚)
- Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· TTL Î³Î¹Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± tasks

---

### **3. Celery Tasks** (`backend/tasks.py`)

**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÏÎ³Î±ÏƒÎ¹ÏŽÎ½ ÏƒÏ„Î¿ background

**ÎšÏÏÎ¹Î¿ task: `deploy_infrastructure`**
```python
@celery_app.task(bind=True, base=DatabaseTask)
def deploy_infrastructure(self, deployment_id, provider_type, ...):
    # 1. Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î· Î²Î¬ÏƒÎ· - status ÏƒÎµ RUNNING
    # 2. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ provider instance
    # 3. Î•ÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¿ deployment
    # 4. Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î· Î²Î¬ÏƒÎ· Î¼Îµ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±
    # 5. Î•Î½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Ï„Î¿ Celery task state (Î³Î¹Î± monitoring)
```

**DatabaseTask base class:**
```python
class DatabaseTask(Task):
    _db = None

    @property
    def db(self):
        if self._db is None:
            self._db = SessionLocal()
        return self._db

    def after_return(self, *args, **kwargs):
        if self._db is not None:
            self._db.close()
```
**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· DB session Î±Î½Î¬ task

---

### **4. ÎœÎ¿Î½Ï„Î­Î»Î± Î’Î¬ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½** (`backend/database.py`)

**Î£Ï‡Î®Î¼Î±:**

#### **Î Î¯Î½Î±ÎºÎ±Ï‚ Deployment**
```sql
CREATE TABLE deployments (
    deployment_id VARCHAR(50) PRIMARY KEY,
    provider_type VARCHAR(50) NOT NULL,
    cloud_provider VARCHAR(20) NOT NULL,
    template_name VARCHAR(200) NOT NULL,
    resource_group VARCHAR(200),
    status VARCHAR(20) NOT NULL,  -- pending, running, completed, failed
    created_at TIMESTAMP NOT NULL,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    parameters JSONB,  -- Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹ Ï„Î¿Ï… template
    outputs JSONB,     -- ÎˆÎ¾Î¿Î´Î¿Î¹ Ï„Î¿Ï… deployment
    error_message TEXT,
    logs TEXT,
    celery_task_id VARCHAR(100)
);

CREATE INDEX idx_deployments_status ON deployments(status);
CREATE INDEX idx_deployments_created ON deployments(created_at DESC);
```

#### **Î Î¯Î½Î±ÎºÎ±Ï‚ TerraformState** (Î³Î¹Î± Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ® Ï‡ÏÎ®ÏƒÎ·)
```sql
CREATE TABLE terraform_states (
    deployment_id VARCHAR(50) PRIMARY KEY,
    backend_type VARCHAR(20) NOT NULL,  -- s3, azurerm, gcs
    backend_config JSONB NOT NULL,
    state_version VARCHAR(20),
    last_modified TIMESTAMP,
    workspace VARCHAR(100)
);
```

**Î£ÏÎ½Î´ÎµÏƒÎ·:**
```python
DATABASE_URL = "postgresql://apiuser:password@postgres:5432/multicloud"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(bind=engine)
```

---

### **5. Provider Factory** (`backend/providers/factory.py`)

**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î¿ ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î¿ cloud provider instance

**Pattern:** Factory + Strategy

```python
class ProviderFactory:
    _providers = {
        "azure": AzureNativeProvider,
        "terraform-aws": TerraformProvider,
        "terraform-gcp": TerraformProvider,
        "terraform-azure": TerraformProvider,
    }

    @staticmethod
    def create_provider(provider_type: str, **kwargs):
        if provider_type not in ProviderFactory._providers:
            raise ValueError(f"Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚ provider: {provider_type}")

        provider_class = ProviderFactory._providers[provider_type]

        # Î•Î¹Î´Î¹ÎºÏŒÏ‚ Ï‡ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± Terraform
        if provider_type.startswith("terraform-"):
            cloud = provider_type.split("-")[1]  # aws, gcp, azure
            return provider_class(cloud_platform=cloud, **kwargs)

        return provider_class(**kwargs)
```

---

### **6. Cloud Providers**

#### **Base Provider** (`backend/providers/base.py`)
```python
class CloudProvider(ABC):
    @abstractmethod
    async def deploy(self, template_path, resource_group_name, parameters):
        """ÎšÎ¬Î½ÎµÎ¹ deploy infrastructure"""
        pass

    @abstractmethod
    async def list_resource_groups(self):
        """Î›Î¯ÏƒÏ„Î± resource groups"""
        pass

    @abstractmethod
    def get_provider_type(self) -> ProviderType:
        """Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î¿Î½ Ï„ÏÏ€Î¿ Ï„Î¿Ï… provider"""
        pass
```

#### **Azure Native Provider** (`backend/providers/azure_native.py`)
- Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Azure SDK (`azure-mgmt-resource`)
- ÎœÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¯Î¶ÎµÎ¹ Bicep â†’ ARM JSON
- ÎšÎ¬Î½ÎµÎ¹ deploy Î¼Î­ÏƒÏ‰ Azure Resource Manager
- Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ 15 Bicep templates

**Î’Î±ÏƒÎ¹ÎºÎ® Î¼Î­Î¸Î¿Î´Î¿Ï‚:**
```python
async def deploy(self, template_path, resource_group_name, parameters):
    # 1. ÎœÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¯Î¶ÎµÎ¹ Bicep ÏƒÎµ ARM JSON
    arm_template = self.compile_bicep(template_path)

    # 2. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ resource group
    self.resource_client.resource_groups.create_or_update(
        resource_group_name,
        {"location": self.region}
    )

    # 3. ÎšÎ¬Î½ÎµÎ¹ deploy Ï„Î¿ ARM template
    deployment = self.resource_client.deployments.begin_create_or_update(
        resource_group_name,
        deployment_name,
        {
            "properties": {
                "template": arm_template,
                "parameters": parameters,
                "mode": "Incremental"
            }
        }
    )

    # 4. Î ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ Ï„Î·Î½ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· (blocking!)
    result = deployment.result()

    return DeploymentResult(...)
```

#### **Terraform Provider** (`backend/providers/terraform_provider.py`)
- Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ subprocess Î³Î¹Î± Î½Î± Ï„ÏÎ­Î¾ÎµÎ¹ Ï„Î¿ `terraform` CLI
- Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ AWS, GCP, Azure
- Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ workspace
- Î§ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ 7 Terraform templates (3 AWS + 3 GCP + 1 Azure)

**Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î¼Î­Î¸Î¿Î´Î¿Î¹:**
```python
def __init__(self, cloud_platform, region, subscription_id):
    self.cloud_platform = cloud_platform  # aws, gcp, azure
    self.working_dir = tempfile.mkdtemp()  # /tmp/terraform_xyz/
    self._check_terraform_installed()

async def deploy(self, template_path, resource_group_name, parameters):
    # 1. Î•Ï„Î¿Î¹Î¼Î¬Î¶ÎµÎ¹ Ï„Î¿ workspace
    self._setup_workspace(template_path, parameters)

    # 2. terraform init
    self._run_terraform_command(["init"])

    # 3. terraform plan
    self._run_terraform_command(["plan", "-out=tfplan"])

    # 4. terraform apply
    self._run_terraform_command(["apply", "-auto-approve", "tfplan"])

    # 5. Î Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î± outputs
    outputs = self._get_terraform_outputs()

    return DeploymentResult(...)

def _run_terraform_command(self, command: List[str]):
    result = subprocess.run(
        ["terraform"] + command,
        cwd=self.working_dir,
        capture_output=True,
        text=True,
        timeout=3600  # ÎœÎ­Î³Î¹ÏƒÏ„Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚ 1 ÏŽÏÎ±
    )
    if result.returncode != 0:
        raise DeploymentError(result.stderr)
```

---

### **7. Template Manager** (`backend/template_manager.py`)

**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î‘Î½Î±ÎºÎ±Î»ÏÏ€Ï„ÎµÎ¹ ÎºÎ±Î¹ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ infrastructure templates

**Î‘Î½Î±ÎºÎ¬Î»Ï…ÏˆÎ· templates:**
```python
def __init__(self, templates_root: str):
    self.templates_root = Path(templates_root)
    self._templates_cache = {
        "bicep": [],
        "terraform-aws": [],
        "terraform-gcp": [],
        "terraform-azure": []
    }
    self._scan_templates()

def _scan_templates(self):
    # Î£ÎºÎ±Î½Î¬ÏÎµÎ¹ Î³Î¹Î± Bicep templates (*.bicep)
    for bicep_file in self.templates_root.glob("*.bicep"):
        metadata = self._extract_bicep_metadata(bicep_file)
        self._templates_cache["bicep"].append(metadata)

    # Î£ÎºÎ±Î½Î¬ÏÎµÎ¹ Î³Î¹Î± Terraform templates
    tf_aws = self.templates_root / "terraform" / "aws"
    for tf_file in tf_aws.glob("*.tf"):
        metadata = self._extract_terraform_metadata(tf_file, "aws")
        self._templates_cache["terraform-aws"].append(metadata)
```

**Î”Î¿Î¼Î® templates:**
```
templates/
â”œâ”€â”€ app-service.bicep                  # Azure App Service
â”œâ”€â”€ storage-account.bicep              # Azure Storage
â”œâ”€â”€ function-app.bicep                 # Azure Functions
â”œâ”€â”€ ...                                # 15 Bicep templates
â””â”€â”€ terraform/
    â”œâ”€â”€ aws/
    â”‚   â”œâ”€â”€ storage-bucket.tf          # S3 Bucket
    â”‚   â”œâ”€â”€ compute-instance.tf        # EC2 Instance
    â”‚   â””â”€â”€ lambda-function.tf         # Lambda Function
    â”œâ”€â”€ gcp/
    â”‚   â”œâ”€â”€ storage-bucket.tf          # GCS Bucket
    â”‚   â”œâ”€â”€ compute-instance.tf        # Compute Engine
    â”‚   â””â”€â”€ cloud-function.tf          # Cloud Functions
    â””â”€â”€ azure/
        â””â”€â”€ storage-account.tf         # Storage Î¼Î­ÏƒÏ‰ Terraform
```

---

## ðŸ—„ï¸ Î£Ï‡Î®Î¼Î± Î’Î¬ÏƒÎ·Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ {#database}

### **Î£Ï‡Î­ÏƒÎµÎ¹Ï‚ ÎŸÎ½Ï„Î¿Ï„Î®Ï„Ï‰Î½**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Deployment         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK deployment_id        â”‚
â”‚    provider_type        â”‚
â”‚    cloud_provider       â”‚
â”‚    template_name        â”‚
â”‚    resource_group       â”‚
â”‚    status               â”‚â—„â”€â”€â”€â”€â”
â”‚    created_at           â”‚     â”‚
â”‚    started_at           â”‚     â”‚ 1:1
â”‚    completed_at         â”‚     â”‚
â”‚    parameters (JSON)    â”‚     â”‚
â”‚    outputs (JSON)       â”‚     â”‚
â”‚    error_message        â”‚     â”‚
â”‚    logs                 â”‚     â”‚
â”‚    celery_task_id       â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                 â”‚
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   TerraformState        â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚ PK deployment_id        â”‚â”€â”€â”€â”€â”€â”˜
â”‚    backend_type         â”‚
â”‚    backend_config(JSON) â”‚
â”‚    state_version        â”‚
â”‚    last_modified        â”‚
â”‚    workspace            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Î¡Î¿Î® Status**

```
PENDING â”€â”€â†’ RUNNING â”€â”€â†’ COMPLETED
(Î‘Î½Î±Î¼Î¿Î½Î®)  (Î•ÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹)  (ÎŸÎ»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ)
                  â”‚
                  â””â”€â”€â†’ FAILED
                  â”‚    (Î‘Ï€Î­Ï„Ï…Ï‡Îµ)
                  â”‚
                  â””â”€â”€â†’ CANCELLED
                       (Î‘ÎºÏ…ÏÏŽÎ¸Î·ÎºÎµ)
```

---

## ðŸš€ Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Deployment (Î Î»Î®ÏÎ·Ï‚ Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹Î±) {#deployment}

### **Î¦Î¬ÏƒÎ· 1: Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ API Request** (100-200ms)

**1.1 Î¤Î¿ Î±Î¯Ï„Î·Î¼Î± Ï†Ï„Î¬Î½ÎµÎ¹ ÏƒÏ„Î¿ FastAPI**
```
Î ÎµÎ»Î¬Ï„Î·Ï‚ â†’ Nginx/Load Balancer â†’ FastAPI â†’ Route: POST /deploy
```

**1.2 ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¼Îµ Pydantic**
```python
class DeploymentRequest(BaseModel):
    template_name: str      # Î¥Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏŒ
    provider_type: str      # Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿Ï‚ provider
    subscription_id: str    # Cloud account ID
    resource_group: str     # Î Î¿Ï… Î¸Î± Î³Î¯Î½ÎµÎ¹ Ï„Î¿ deploy
    location: str           # Region
    parameters: Dict[str, Any]  # Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹ template
```

**1.3 ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ template**
```python
template_path = template_manager.get_template_path(
    "storage-bucket",
    "terraform-aws"
)
# Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹: /app/templates/terraform/aws/storage-bucket.tf
```

**1.4 Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ ÏƒÏ„Î· Î²Î¬ÏƒÎ·**
```python
deployment = Deployment(
    deployment_id=generate_unique_id(),
    provider_type="terraform-aws",
    status="pending",
    parameters=request.parameters
)
db.add(deployment)
db.commit()
```

**1.5 Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· task ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬**
```python
task = deploy_task.delay(
    deployment_id=deployment.deployment_id,
    ...
)
# Î¤Î¿ Task ÎµÎ¯Î½Î±Î¹ Ï„ÏŽÏÎ± ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬ Ï„Î¿Ï… Redis
```

**1.6 Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î·**
```json
HTTP 202 Accepted
{
  "deployment_id": "deploy-abc123",
  "status": "pending",
  "task_id": "celery-task-xyz"
}
```

---

### **Î¦Î¬ÏƒÎ· 2: Î•ÎºÏ„Î­Î»ÎµÏƒÎ· Celery Task** (2-10 Î»ÎµÏ€Ï„Î¬)

**2.1 ÎŸ Worker Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿ task**
```bash
[2025-11-09 12:00:00] Î›Î®Ï†Î¸Î·ÎºÎµ task: deploy_infrastructure
[2025-11-09 12:00:00] Task ID: celery-task-xyz
```

**2.2 Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· status ÏƒÎµ RUNNING**
```sql
UPDATE deployments
SET status = 'running', started_at = NOW()
WHERE deployment_id = 'deploy-abc123';
```

**2.3 Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· provider**
```python
provider = ProviderFactory.create_provider(
    "terraform-aws",
    subscription_id="123456789012",
    region="us-east-1"
)
```

**2.4 Î•Ï„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Terraform workspace**
```bash
mkdir /tmp/terraform_xyz/
cp /app/templates/terraform/aws/storage-bucket.tf /tmp/terraform_xyz/main.tf

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± terraform.tfvars
echo 'bucket_name = "my-bucket"' > /tmp/terraform_xyz/terraform.tfvars

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± providers.tf
cat > /tmp/terraform_xyz/providers.tf <<EOF
provider "aws" {
  region = "us-east-1"
}
EOF
```

**2.5 Terraform init** (~30 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±)
```bash
$ terraform init
Initializing provider plugins...
- Finding hashicorp/aws versions...
- Installing hashicorp/aws v5.31.0...
Terraform has been successfully initialized!
```

**2.6 Terraform plan** (~10 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±)
```bash
$ terraform plan -out=tfplan
Î¤Î¿ Terraform Î¸Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Ï„Î¹Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚:
  # aws_s3_bucket.main Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯
  + resource "aws_s3_bucket" "main" {
      + bucket = "my-bucket"
      + region = "us-east-1"
    }
Plan: 1 Ï€ÏÎ¿Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·, 0 Ï€ÏÎ¿Ï‚ Î±Î»Î»Î±Î³Î®, 0 Ï€ÏÎ¿Ï‚ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ¿Ï†Î®.
```

**2.7 Terraform apply** (~1-5 Î»ÎµÏ€Ï„Î¬)
```bash
$ terraform apply -auto-approve tfplan
aws_s3_bucket.main: Creating...
aws_s3_bucket.main: Still creating... [10s elapsed]
aws_s3_bucket.main: Creation complete after 2s [id=my-bucket]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:
bucket_name = "my-bucket"
bucket_arn = "arn:aws:s3:::my-bucket"
```

**2.8 Î•Î¾Î±Î³Ï‰Î³Î® outputs**
```bash
$ terraform output -json
{
  "bucket_name": {"value": "my-bucket"},
  "bucket_arn": {"value": "arn:aws:s3:::my-bucket"}
}
```

**2.9 Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î²Î¬ÏƒÎ·Ï‚**
```sql
UPDATE deployments
SET
  status = 'completed',
  completed_at = NOW(),
  outputs = '{"bucket_name": "my-bucket", "bucket_arn": "arn:aws:s3:::my-bucket"}'
WHERE deployment_id = 'deploy-abc123';
```

---

### **Î¦Î¬ÏƒÎ· 3: Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Status**

**ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ ÎºÎ¬Î½ÎµÎ¹ polling Î³Î¹Î± Ï„Î¿ status:**
```bash
# ÎšÎ¬Î¸Îµ 5 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
GET /deployments/deploy-abc123/status

# Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏŒÏ„Î±Î½ Ï„ÏÎ­Ï‡ÎµÎ¹:
{"status": "running", "duration_seconds": 45}

# Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏŒÏ„Î±Î½ Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¸ÎµÎ¯:
{"status": "completed", "outputs": {...}}
```

---

## ðŸ³ Docker & Î¥Ï€Î¿Î´Î¿Î¼Î® {#docker}

### **Docker Compose Stack**

```yaml
services:
  api:          # FastAPI ÎµÏ†Î±ÏÎ¼Î¿Î³Î®
  celery-worker:# Background task processor
  postgres:     # Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
  redis:        # Message broker
```

### **Î¡Î¿Î® Î”Î¹ÎºÏ„ÏÎ¿Ï…**

```
Î•Î¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¬ â†’ Port 8000 â†’ api container
                       â†“
api â†’ postgres:5432 (ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÏŒ Î´Î¯ÎºÏ„Ï…Î¿)
api â†’ redis:6379 (ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÏŒ Î´Î¯ÎºÏ„Ï…Î¿)
                       â†“
celery-worker â† redis:6379 (Ï€Î±Î¯ÏÎ½ÎµÎ¹ tasks)
celery-worker â†’ postgres:5432 (ÎµÎ½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Î²Î¬ÏƒÎ·)
celery-worker â†’ AWS/Azure/GCP APIs (ÎºÎ¬Î½ÎµÎ¹ deploy infrastructure)
```

### **Volume Mounts**

```
./logs â†’ /app/logs (api & worker)
./templates â†’ /app/templates (api & worker)
redis-data â†’ /data (redis)
postgres-data â†’ /var/lib/postgresql/data (postgres)
```

---

## ðŸ“ Î”Î¿Î¼Î® Î‘ÏÏ‡ÎµÎ¯Ï‰Î½ {#structure}

```
project/
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ api_rest.py              # FastAPI ÎµÏ†Î±ÏÎ¼Î¿Î³Î® (600 Î³ÏÎ±Î¼Î¼Î­Ï‚)
â”‚   â”œâ”€â”€ celery_app.py            # Î”Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Celery
â”‚   â”œâ”€â”€ tasks.py                 # Celery tasks (deploy, cleanup)
â”‚   â”œâ”€â”€ database.py              # SQLAlchemy models
â”‚   â”œâ”€â”€ template_manager.py      # Î‘Î½Î±ÎºÎ¬Î»Ï…ÏˆÎ· templates (300 Î³ÏÎ±Î¼Î¼Î­Ï‚)
â”‚   â”‚
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ base.py              # Abstract base class
â”‚       â”œâ”€â”€ factory.py           # Provider factory
â”‚       â”œâ”€â”€ azure_native.py      # Azure Bicep provider
â”‚       â””â”€â”€ terraform_provider.py# Terraform provider
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ *.bicep                  # 15 Azure templates
â”‚   â””â”€â”€ terraform/
â”‚       â”œâ”€â”€ aws/*.tf             # 3 AWS templates
â”‚       â”œâ”€â”€ gcp/*.tf             # 3 GCP templates
â”‚       â””â”€â”€ azure/*.tf           # 1 Azure template
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                    # Unit tests
â”‚   â”œâ”€â”€ integration/             # API tests
â”‚   â””â”€â”€ e2e/                     # End-to-end tests
â”‚
â”œâ”€â”€ docs/                        # 9 Î¿Î´Î·Î³Î¿Î¯ Ï„ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·Ï‚
â”œâ”€â”€ examples/                    # Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Ï‡ÏÎ®ÏƒÎ·Ï‚ API
â”œâ”€â”€ scripts/                     # Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ¬ scripts
â”‚
â”œâ”€â”€ docker-compose.yml           # Î•Î½Î¿ÏÏ‡Î®ÏƒÏ„ÏÏ‰ÏƒÎ· Ï€Î»Î®ÏÎ¿Ï…Ï‚ stack
â”œâ”€â”€ Dockerfile                   # API container
â”œâ”€â”€ requirements.txt             # Python dependencies
â”œâ”€â”€ .env.example                 # Template Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚
â””â”€â”€ README.md                    # Î¤ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ· project
```

---

## ðŸ”‘ Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î‘Ï€Î¿Ï†Î¬ÏƒÎµÎ¹Ï‚ Î£Ï‡ÎµÎ´Î¹Î±ÏƒÎ¼Î¿Ï

### **Î“Î¹Î±Ï„Î¯ Celery Î±Î½Ï„Î¯ Î³Î¹Î± FastAPI BackgroundTasks;**
- âœ… Persistent queue (ÎµÏ€Î¹Î²Î¹ÏŽÎ½ÎµÎ¹ Î±Ï€ÏŒ restarts Ï„Î¿Ï… API)
- âœ… Distributed workers (horizontal scaling)
- âœ… Î›Î¿Î³Î¹ÎºÎ® ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚ tasks
- âœ… Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Ï€ÏÎ¿ÏŒÎ´Î¿Ï…
- âœ… Î‘ÎºÏÏÏ‰ÏƒÎ· tasks

### **Î“Î¹Î±Ï„Î¯ PostgreSQL Î±Î½Ï„Î¯ Î³Î¹Î± MongoDB;**
- âœ… ACID compliance (ÎºÏÎ¯ÏƒÎ¹Î¼Î¿ Î³Î¹Î± deployments)
- âœ… Î™ÏƒÏ‡Ï…ÏÎ® ÏƒÏ…Î½Î­Ï€ÎµÎ¹Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
- âœ… Î Î»Î¿ÏÏƒÎ¹ÎµÏ‚ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„ÎµÏ‚ ÎµÏÏ‰Ï„Î·Î¼Î¬Ï„Ï‰Î½ (Ï†Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î±, Ï„Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·)
- âœ… Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· JSON (JSONB Î³Î¹Î± parameters/outputs)

### **Î“Î¹Î±Ï„Î¯ Redis Ï‰Ï‚ broker;**
- âœ… In-memory Ï„Î±Ï‡ÏÏ„Î·Ï„Î±
- âœ… Atomic operations
- âœ… Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· TTL
- âœ… Î‘Ï€Î»Î® ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·

### **Î“Î¹Î±Ï„Î¯ Factory pattern Î³Î¹Î± providers;**
- âœ… Î•ÏÎºÎ¿Î»Î· Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Ï‰Î½ cloud providers
- âœ… Î•Î½Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ interface
- âœ… Î•Ï€Î¹Î»Î¿Î³Î® provider ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· (runtime)

---

## ðŸ“Š Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±: Î Î»Î®ÏÎ·Ï‚ Î¡Î¿Î® Î¼Îµ Î§ÏÏŒÎ½Î¿Ï…Ï‚

```
t=0s      â”‚ Î ÎµÎ»Î¬Ï„Î·Ï‚ ÏƒÏ„Î­Î»Î½ÎµÎ¹ POST /deploy
          â”‚
t=0.1s    â”‚ FastAPI: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚
          â”‚ FastAPI: Î•Î³Î³ÏÎ±Ï†Î® ÏƒÏ„Î· Î²Î¬ÏƒÎ·
          â”‚ FastAPI: Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ Î¿Ï…ÏÎ¬ Celery
          â”‚ FastAPI: Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® 202 Accepted
          â”‚
t=0.2s    â”‚ Celery Worker: Î›Î®ÏˆÎ· task Î±Ï€ÏŒ Redis
          â”‚
t=0.3s    â”‚ Worker: Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· status â†’ RUNNING
          â”‚ Worker: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± TerraformProvider
          â”‚
t=1s      â”‚ Worker: Î•Ï„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Terraform workspace
          â”‚
t=30s     â”‚ Worker: terraform init (ÎºÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± plugins)
          â”‚
t=40s     â”‚ Worker: terraform plan
          â”‚
t=50s     â”‚ Worker: terraform apply (Î±ÏÏ‡Î® Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï€ÏŒÏÏ‰Î½)
          â”‚
t=2m      â”‚ AWS: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± S3 bucket
          â”‚
t=2m 10s  â”‚ Worker: Î•Î¾Î±Î³Ï‰Î³Î® outputs
          â”‚ Worker: Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î²Î¬ÏƒÎ·Ï‚ â†’ COMPLETED
          â”‚
t=2m 15s  â”‚ Î ÎµÎ»Î¬Ï„Î·Ï‚: GET /deployments/{id}/status
          â”‚ API: Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ status="completed" Î¼Îµ outputs
```

---

## ðŸŽ“ Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ¬ Î£Î·Î¼ÎµÎ¯Î± Ï€Î¿Ï… Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î˜Ï…Î¼Î¬ÏƒÎ±Î¹

### **1. Async vs Sync**
- **FastAPI endpoints**: Async (`async def`) - Î¼Î·-blocking I/O
- **Celery tasks**: Sync (ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒ `def`) - blocking, Î¼Î±ÎºÏÎ¿Ï‡ÏÏŒÎ½Î¹Î±
- **Provider.deploy()**: Î£ÏÎ³Ï‡ÏÎ¿Î½Î¿ - ÎºÎ¬Î½ÎµÎ¹ subprocess calls

### **2. Database Sessions**
- **FastAPI**: Session per request (`Depends(get_db)`)
- **Celery**: Session per task (`DatabaseTask` base class)
- **Î Î¬Î½Ï„Î± ÎºÎ¬Î½Îµ `db.commit()` Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ Î±Î»Î»Î±Î³Î­Ï‚**
- **Î Î¬Î½Ï„Î± ÎºÎ¬Î½Îµ `db.close()` ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚**

### **3. Error Handling**
- **API Layer**: Î Î¹Î¬Î½ÎµÎ¹ exceptions, ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ HTTP errors
- **Celery Tasks**: Î Î¹Î¬Î½ÎµÎ¹ exceptions, ÎµÎ½Î·Î¼ÎµÏÏŽÎ½ÎµÎ¹ Î²Î¬ÏƒÎ·, ÏƒÎ·ÎºÏŽÎ½ÎµÎ¹ exception Î¾Î±Î½Î¬
- **Providers**: Î£Î·ÎºÏŽÎ½Î¿Ï…Î½ `DeploymentError` Î® `ProviderConfigurationError`

### **4. Status Tracking**
- **Database**: Source of truth Î³Î¹Î± deployment status
- **Celery**: Task state Î³Î¹Î± real-time monitoring
- **Client**: ÎšÎ¬Î½ÎµÎ¹ polling ÏƒÏ„Î¿ `/deployments/{id}/status`

### **5. Template Discovery**
- **Î£Ï„Î·Î½ ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·**: Î£ÎºÎ±Î½Î¬ÏÎµÎ¹ ÏŒÎ»Î± Ï„Î± templates
- **Cache in memory**: Î“ÏÎ®Î³Î¿ÏÎ· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·
- **Metadata extraction**: Î Î±Î¯ÏÎ½ÎµÎ¹ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±Ï€ÏŒ comments ÏƒÏ„Î± templates

---

## ðŸš¨ Î Î¹Î¸Î±Î½Î¬ Î ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± ÎºÎ±Î¹ Î›ÏÏƒÎµÎ¹Ï‚

### **Î ÏÏŒÎ²Î»Î·Î¼Î± 1: Celery task "Ï‡Î¬Î½ÎµÏ„Î±Î¹"**
**Î‘Î¹Ï„Î¯Î±:** Redis restart, worker crash
**Î›ÏÏƒÎ·:**
```python
# Î£Ï„Î¿ celery_app.py
task_acks_late = True  # Task acknowledged Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·
task_reject_on_worker_lost = True  # Î•Ï€Î±Î½ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Î±Î½ Ï‡Î±Î¸ÎµÎ¯ Î¿ worker
```

### **Î ÏÏŒÎ²Î»Î·Î¼Î± 2: Deployment timeout**
**Î‘Î¹Ï„Î¯Î±:** Terraform deployment Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ 1 ÏŽÏÎ±
**Î›ÏÏƒÎ·:**
```python
# Î£Ï„Î¿ tasks.py
@celery_app.task(time_limit=7200)  # 2 ÏŽÏÎµÏ‚
def deploy_infrastructure(...):
```

### **Î ÏÏŒÎ²Î»Î·Î¼Î± 3: Database connection pool exhausted**
**Î‘Î¹Ï„Î¯Î±:** Î Î¿Î»Î»Î¬ concurrent requests
**Î›ÏÏƒÎ·:**
```python
# Î£Ï„Î¿ database.py
engine = create_engine(
    DATABASE_URL,
    pool_size=20,  # Î‘ÏÎ¾Î·ÏƒÎ· pool size
    max_overflow=40
)
```

### **Î ÏÏŒÎ²Î»Î·Î¼Î± 4: Redis memory full**
**Î‘Î¹Ï„Î¯Î±:** Î Î¿Î»Î»Î¬ task results Ï€Î¿Ï… Î´ÎµÎ½ ÎºÎ±Î¸Î±ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹
**Î›ÏÏƒÎ·:**
```python
# Î£Ï„Î¿ celery_app.py
result_expires = 3600 * 24  # 1 Î¼Î­ÏÎ± TTL
```

---

Î¤ÏŽÏÎ± Ï„Î¿ ÎºÎ±Ï„Î¬Î»Î±Î²ÎµÏ‚ Ï€Î¿Î»Ï ÎºÎ±Î»ÏÏ„ÎµÏÎ±; ÎˆÏ‡ÎµÎ¹Ï‚ ÎºÎ¬Ï€Î¿Î¹Î± ÎµÏÏŽÏ„Î·ÏƒÎ· Î³Î¹Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ ÎºÎ¿Î¼Î¼Î¬Ï„Î¹;
